# Load Balancing

Load balancers are servers that forward internet traffic to multiple servers (EC2 instances) downstream.

![](../../../images/2019-11-22-14-01-25.png)

## Why use a load balancer?
- Spread load accross multiple downstream instances
- Expose a single point of access (DNS) to your application
- Seamlessly handle failures of downstream instances
- Do regular health checks to your instances
- Provide SSL termintaion (HTTPS) for your websites
- Enforce stickiness with cookies
- High availability accross zones
- Separate public traffic from private traffic

## Why use an EC2 Load Balancer?
- An ELB (EC2 Load Balancer) is a manged load balancer
    - AWS guarantees that it will be working
    - AWS takes care of upgrades, maintenance, high availability
    - AWS provides only a few configuration knobs
- It costs less to setup your own load balancer but it will be a lot more effort on your end.
- It is integrated with many AWS offerings / services

## Types of load balancers on AWS
- Classic Load Balancer (v1 - old generation) - 2009
- Application Load Balancer (v2 - new generation) - 2016
- Network Load Balancer (v2 - new generation) - 2017

Overall, it is recommended to use the newer / v2 generation load balancers as they provide more features.

You can setup internal (private) or external (public) ELBs.

## Health Checks

- Health Checks are cruical for Load Balancers
- They enable the load balancer to know if instances it forwards traffic to are available to reply to requests
- The health check is done on a port and a route (/health is common)
- If the response is not 200 (OK), then the instance is unhealthy

![](../../../images/2019-11-22-14-08-13.png)

## Application Load Balancer (v2)

- Application load balancers (Layer 7) allow to do:
    - Load balancing to multiple HTTP applications accross machines (target groups)
    - Load balancing to multiple applications on the same machine (ex: containers)
    - Load balancing based on route in URL
    - Load Balancing based on hostname in URL
- Basically, they're awesome for micro services & container-based applications (example: Docker & Amazon ECS)
- Has a port mapping feature to redirect to a dynamic port
- In comparison, we would need to create one Classic Load Balancer per application before. That was very expensive and inefficient.

![](../../../images/2019-11-22-14-11-49.png)

- Stickiness can be enabled at the target group level
    - Same request goes to the same instance
    - Stickiness is directly generated by the ALB (not the application)
- ALB support HTTP/HTTPS & Websockets protocols
- The application servers don't see the IP of the client directly
    - The true IP of the client is inserted in the header X-Forwarded-For.
    - We can also get Port (X-Forwarded-Port) and proto (X-Forwarded-Proto)

![](../../../images/2019-11-22-14-14-26.png)

## Network Load Balancer (v2)

- Network load balancers (layer 4) allow to do:
    - Forward TCP traffic to your instances
    - Handle millions of requests per seconds
    - Support for static IP or elastic IP
    - Less latency ~100ms (vs 400ms for ALB)
- Network Load Balancers are mostly used for extreme performance and should not be the the default load balancer you choose
- Overall, the creation process is the same as ALB

![](../../../images/2019-11-22-14-16-45.png)


## Good to know
- Classic Load Balancers are Deprecated
    - Application Load Balancers for HTTP / HTTPS & Websockets
    - Network Load Balancer for TCP
- CLB and ALB support SSL certificates and provide SSL termination
- All Load Balancers have health check capability
- ALB can route based on hostname / path
- ALB is a great fit with ECS (docker)
- Any Load Balancer (CLB, ALB, NLB) has a static host name. Do not resolve and use underlying IP.
- LBs can scale but not instanteneously - contact AWS for a "warm-up"
- NLB directly see the client IP
- 4xx errors are client induced errors
- 5xx errors are application induced errors
    - Load Balancer Errors 503 means at capacity or no registed target
- If the LB can't connect to your application, check your security groups.

## Hands On

We can create a Load Balancer in `Load Balancers` section. There we can choose between the 3 types of load balancers:

![](../../../images/2019-11-22-14-25-39.png)

![](../../../images/2019-11-22-14-27-17.png)

![](../../../images/2019-11-22-14-28-34.png)

![](../../../images/2019-11-22-14-29-36.png)

![](../../../images/2019-11-22-14-33-21.png)

![](../../../images/2019-11-22-14-33-55.png)

Once the Load Balancer has been provisioned, we can get it's DNS name.

![](../../../images/2019-11-22-14-35-13.png)

And when opening it via browser, it should be working:

![](../../../images/2019-11-22-14-35-57.png)

In listeners section we can see that the port 80 is forwarded to the `my-apache-target-group`, if we want we can add more target groups.

![](../../../images/2019-11-22-14-37-17.png)

Or even add custom rules

![](../../../images/2019-11-22-14-38-18.png)

When visiting the target group, we can add more targets to the group.

![](../../../images/2019-11-22-14-39-16.png)

Lastly, we can go to the `Security Groups` and modify the `my-first-security-group` that the `web app` uses to accept traffic only from the load balancer.

![](../../../images/2019-11-22-14-41-16.png)

So now, when we visit the load balancer URL, everything should be working, but we visit the ec2 directly, it has a timeout.

## Adding instances to Load Balancer

Currently the Load Balancer isn't really doing any load balancing, since there is only one instance. We might want to add more intances.

Now, we'll create 3 instances with user data like in the previous sections.

![](../../../images/2019-11-22-14-49-24.png)

Now we can go to the `Target Groups` and add these targets.

![](../../../images/2019-11-22-14-50-07.png)

Now, when refreshing the load balancer url, we should see different hostnames.

![](../../../images/2019-11-22-14-51-01.png)

![](../../../images/2019-11-22-14-51-17.png)

![](../../../images/2019-11-22-14-51-34.png)

## Stickiness

- It is possible to implement stickiness so that the same client is always redirected to the same instance behind a load balancer
- This works for Classic Load Balancers & Application Load Balancers
- The "cookie" used for stickiness has an expiration date you control
- Use case: make sure the user doesn't lose his session data
- Enabling stickiness may bring imbalance to the load over the backend EC2 isntances

The stickiness can be enabled while modifying target groups.

![](../../../images/2019-11-22-14-55-23.png)

## Load Balancers for Solutions Architect

- Classic Load Balancers: questions on security groups, stickiness
- Application Load Balancer (Layer 7 of OSI)
    - Support routing based on hostname
    - Support routing based on path
    - Support redirects (e.g. HTTP to HTTPS)
    - Support dynamic host port mapping with ECS
- NLB (Layer 4 of OSI) gets a static IP per AZ:
    - Public facing: must attach Elastic IP - can help whitelist by clients
    - Private facing: will get random private IP based on free ones at the time of creation
    - Has cross zone balancing
    - Has SSL termination (Jan 2019)